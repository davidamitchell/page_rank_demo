<!doctype html>
<meta charset="utf-8">

<script src="lib/d3.js"></script>
<script src="lib/d3plus.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/sylvester.js"></script>
<script src="lib/pagerank.js"></script>

<!-- create container element for visualization -->
<div id="viz"></div>

<script>
var min_size = 20;

var nodes = {
  alpha:   ['beta', 'gamma'],
  beta:    ['gamma'],
  gamma:   ['zeta'],
  delta:   ['alpha', 'gamma'],
  epsilon: ['alpha', 'gamma'],
  zeta:    ['alpha', 'gamma', 'epsilon'],
  theta:   ['beta', 'gamma', 'epsilon']
};

// var nodes = {
//   zero:   ['one'],
//   one:    ['two'],
//   two:    ['zero','one'],
//   three:  ['zero','one']
// };

var m = build_matrix(nodes);

var adjacencyMatrix = $M(m);

var ranking = adjacencyMatrix.pagerank();

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min)) + min;
}

function pageRankSize(node, nodes, ranking) {

  keys = _.keys(nodes);
  x = _.indexOf(keys, node);
  console.log(x, keys, node);
  console.log(ranking[0]);
  rank = ranking[x];

  return (rank*100) + min_size;
}


function build_matrix(nodes) {
  var matrix = []
  var vector = []

  _.each(nodes, function(targets, source) {
    vector.push(0);
  });
  _.each(vector, function(element){
    matrix.push(vector.slice(0));
  });


  keys = _.keys(nodes)
  _.each(nodes, function(targets, source) {
    x = _.indexOf(keys, source)
    _.each(targets, function(target){
      y = _.indexOf(keys, target);
      matrix[x][y] = 1;
    });
  });

  return matrix;
}

function build_nodes(nodes, size_it, ranking) {
  var size = min_size;
  var nodes = _.map(nodes, function(val, key) {
    if(size_it){
      size = pageRankSize(key, nodes, ranking)
    }
    return { "name": key, "size": size };
  });

  return nodes;
}

function build_connections(nodes) {
  var connections = [];
  _.each(nodes, function(targets, source) {
    _.each(targets, function(target){
      connections.push({"source": source, "target": target});
    });
  });

  return connections;
}

function build_positions(nodes) {
  var x, y = 0
  var positions = _.map(nodes, function(val, key) {
    x = getRandomInt(0, 30)
    y = getRandomInt(0, 30)
    return { "name": key, "x": x, "y": y };
  });

  return positions;
}

var same_sized_data = build_nodes(nodes, false, ranking);
var sized_data = build_nodes(nodes, true, ranking);
var positions = build_positions(nodes);
var connections = build_connections(nodes);

// instantiate d3plus
var visualization = d3plus.viz()
.container("#viz")  // container DIV to hold the visualization
.type("network")    // visualization type
.data(same_sized_data)  // sample dataset to attach to nodes
// .nodes(positions)   // x and y position of nodes
.edges(connections) // list of node connections
.edges({arrows: true})
.edges({interpolate: 'step'})
.size("size")       // key to size the nodes
.id("name")         // key for which our data is unique on
.draw()             // finally, draw the visualization!

var size_it = true;
window.onclick = function(){
  sized_data = build_nodes(nodes, size_it, ranking);
  sized_data.push({"name": "newone", "size": 10})
  positions.push({"name": "newone", "x": 24, "y": 40})
  visualization
  .data(sized_data)
  .draw()

  size_it = !size_it

}


</script>
