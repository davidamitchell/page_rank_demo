<!doctype html>
<meta charset="utf-8">

<script src="d3.js"></script>
<script src="d3plus.js"></script>
<script src="underscore.js"></script>

<!-- create container element for visualization -->
<div id="viz"></div>

<script>
  var min_size = 20;

  var nodes = {
    alpha:   ['beta', 'gamma'],
    beta:    ['gamma'],
    gamma:   ['alpha'],
    delta:   ['alpha', 'beta', 'gamma'],
    epsilon: ['alpha', 'beta', 'gamma'],
    zeta:    ['beta', 'epsilon'],
    theta:   ['beta', 'gamma', 'epsilon']

  };

  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
  }

  function pageRankSize(node, nodes) {
    return Math.pow(4, nodes[node].length) + min_size;
  }

  function build_nodes(nodes, size_it) {
    var size = min_size;
    var nodes = _.map(nodes, function(val, key) {
      if(size_it){
        size = pageRankSize(key, nodes)
        // console.log(pageRankSize(key, nodes))
        // console.log(size)
      }
      return { "name": key, "size": size };
    });

    return nodes;
  }

  function build_connections(nodes) {
    var connections = [];
    _.each(nodes, function(targets, source) {
      var links = _.each(targets, function(target){
        connections.push({"source": source, "target": target});
      });
    });

    return connections;
  }

  function build_positions(nodes) {
    var x, y = 0
    var positions = _.map(nodes, function(val, key) {
      x = getRandomInt(0, 30)
      y = getRandomInt(0, 30)
      return { "name": key, "x": x, "y": y };
    });

    return positions;
  }

  var same_sized_data = build_nodes(nodes, false);
  var sized_data = build_nodes(nodes, true);
  var positions = build_positions(nodes);
  var connections = build_connections(nodes);

  // instantiate d3plus
  var visualization = d3plus.viz()
    .container("#viz")  // container DIV to hold the visualization
    .type("network")    // visualization type
    .data(same_sized_data)  // sample dataset to attach to nodes
    .nodes(positions)   // x and y position of nodes
    .edges(connections) // list of node connections
    .edges({arrows: true})
    .edges({interpolate: 'step'})
    .size("size")       // key to size the nodes
    .id("name")         // key for which our data is unique on
    .draw()             // finally, draw the visualization!


  // After 2 seconds, add another node and connection!
  setTimeout(function(){
//     //add(visualization, nodes, connections, "name", "gamma")
//     sized_data.push({"name": "newone", "size": 24})
//     positions.push({"name": "newone", "x": 24, "y": 40})
//     // connections.push({"source": "newone", "target": "alpha"})
//     console.log('apply ranking')
//     visualization
//       .data(sized_data)
// //      .nodes(positions)
//       // .edges(connections)
//       // .edges({arrows: true})
//       .draw()

  },1300)
  var size_it = true;
  window.onclick = function(){
    sized_data = build_nodes(nodes, size_it);
    sized_data.push({"name": "newone", "size": 10})
    positions.push({"name": "newone", "x": 24, "y": 40})
    visualization
      .data(sized_data)
      .draw()

    size_it = !size_it

  }

</script>
